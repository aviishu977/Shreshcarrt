<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CONNECT GEORGIA</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  :root {
    --color-primary: #2563eb;
    --color-primary-dark: #1e40af;
    --color-background: #f5f7fa;
    --color-card-bg: #ffffff;
    --color-text-primary: #111827;
    --color-text-secondary: #6b7280;
    --color-border: #e5e7eb;
    --color-shadow-light: rgba(0, 0, 0, 0.05);
    --color-shadow-dark: rgba(0, 0, 0, 0.1);
    --radius-base: 18px;
    --spacing-base: 16px;
    --font-family: 'Inter', sans-serif;
  }
  * {
    box-sizing: border-box;
    margin: 0; padding: 0;
  }
  body {
    font-family: var(--font-family);
    background-color: var(--color-background);
    color: var(--color-text-primary);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background-color: var(--color-primary);
    color: white;
    font-weight: 700;
    font-size: 1.5rem;
    padding: var(--spacing-base);
    text-align: center;
    box-shadow: 0 4px 12px var(--color-shadow-dark);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  main {
    flex: 1;
    max-width: 480px;
    margin: var(--spacing-base) auto 2rem;
    width: 95%;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    padding: 0 var(--spacing-base);
  }
  form#postForm {
    background: var(--color-card-bg);
    border-radius: var(--radius-base);
    padding: 1.75rem 1.5rem;
    box-shadow: 0 8px 16px var(--color-shadow-light), inset 0 0 0 1px var(--color-border);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  textarea#contentText {
    resize: vertical;
    min-height: 110px;
    border: 1.5px solid var(--color-border);
    border-radius: 14px;
    padding: 1rem 1.25rem;
    font-size: 1.125rem;
    background: var(--color-background);
  }
  label.camera-button {
    display: inline-block;
    background-color: var(--color-primary);
    color: white;
    padding: 0.9rem 1rem;
    font-weight: 700;
    font-size: 1.1rem;
    border-radius: 14px;
    cursor: pointer;
    transition: 0.3s ease;
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.5);
    user-select: none;
    text-align: center;
    width: fit-content;
  }
  input#imageInput {
    display: none;
  }
  button {
    background-color: var(--color-primary);
    border: none;
    border-radius: 14px;
    padding: 0.5rem 0.5rem;
    font-weight: 700;
    font-size: 1.2rem;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:disabled {
    background-color: #93c5fd;
    cursor: not-allowed;
  }
  img#previewImage {
    max-width: 100%;
    border-radius: 14px;
    object-fit: cover;
    max-height: 280px;
    aspect-ratio: 16 / 9;
    display: none;
  }
  p#imageStatus, p#errorMessage {
    font-size: 0.9rem;
    font-weight: 600;
    min-height: 1.2rem;
  }
  p#imageStatus {
    color: var(--color-text-secondary);
  }
  p#errorMessage {
    color: red;
    display: none;
  }
  section#posts {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  article.post-card {
    background: var(--color-card-bg);
    border-radius: var(--radius-base);
    padding: 1.5rem 1.75rem;
    box-shadow: 0 12px 24px var(--color-shadow-light);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  img.post-image {
    width: 100%;
    height: auto;
    border-radius: 14px;
    object-fit: contain;
  }
  p.post-text {
    font-size: 1.125rem;
    white-space: pre-wrap;
    font-weight: 500;
  }
  time.timestamp {
    font-size: 0.8rem;
    color: var(--color-text-secondary);
    align-self: flex-end;
  }
  button.comments-toggle {
    background-color: var(--color-primary-dark);
    font-size: 1rem;
    padding: 0.4rem 1rem;
    border-radius: 12px;
    width: fit-content;
    margin-top: 0.25rem;
    align-self: flex-start;
    cursor: pointer;
  }
  div.comments-container {
    margin-top: 1rem;
    background-color: #f0f4ff;
    border-radius: 14px;
    padding: 1rem;
    display: none;
    flex-direction: column;
    gap: 0.5rem;
  }
  div.comment-text {
    background: white;
    padding: 0.6rem 1rem;
    border-radius: 12px;
    font-size: 1rem;
    box-shadow: 0 2px 5px var(--color-shadow-light);
  }
  form.comment-form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  form.comment-form textarea {
    resize: vertical;
    min-height: 70px;
    border: 1.5px solid var(--color-border);
    border-radius: 14px;
    padding: 0.5rem 0.75rem;
    font-size: 1rem;
  }
  form.comment-form button {
    background-color: var(--color-primary);
    font-weight: 700;
    border-radius: 14px;
    padding: 0.5rem 0;
    font-size: 1.1rem;
    color: white;
    cursor: pointer;
  }
  /* Inbox modal styles */
  #inboxModal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0,0,0,0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }
  #inboxModal.active {
    display: flex;
  }
  #inboxContent {
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 480px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 1rem 1.5rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    position: relative;
  }
  #inboxContent h2 {
    text-align: center;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: 1rem;
  }
  #inboxCloseBtn {
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 1.7rem;
    font-weight: 700;
    color: var(--color-primary-dark);
    background: none;
    border: none;
    cursor: pointer;
    user-select: none;
  }
  div.inbox-comment {
    background: #f0f4ff;
    padding: 0.6rem 1rem;
    border-radius: 12px;
    font-size: 1rem;
    box-shadow: 0 2px 5px var(--color-shadow-light);
  }
  /* Loading spinner */
  #loadingSpinner {
    display: none;
    margin: 2rem auto;
    border: 5px solid #e5e7eb;
    border-top: 5px solid var(--color-primary);
    border-radius: 50%;
    width: 48px;
    height: 48px;
    animation: spin1s linear infinite;
  }
  #loadingSpinner.active {
    display: block;
  }
  @keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#loadingSpinner {
  display: none;
  margin: 2rem auto;
  border: 5px solid #e5e7eb;
  border-top: 5px solid var(--color-primary);
  border-radius: 50%;
  width: 48px;
  height: 48px;
  animation: spin 1s linear infinite;
}
#loadingSpinner.active {
  display: block;
}
  .inbox-comment {
    background-color: #ffffff;
    padding: 12px 16px;
    margin-bottom: 12px;
    border-radius: 14px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    font-size: 1rem;
    line-height: 1.4;
    color: #111827;
    border: 1px solid #e5e7eb;
  }
</style>
</head>
<body>
<header>
  CONNECT GEORGIA
  <button id="openInboxBtn" title="ინბოქსი" style="border: 2px solid white;position: fixed;top: 60px;right: 0px;" >✉️</button>
</header>
<main>
  <form id="postForm" autocomplete="off" novalidate>
    <label for="imageInput" class="camera-button">ფოტოს გადაღება</label>
    <input type="file" id="imageInput" accept="image/*" capture="environment" />
    <img id="previewImage" alt="ფოტოს პრევიუ" />
    <p id="imageStatus"></p>
    <p id="errorMessage">ფოტოს დამატება სავალდებულოა!</p>
    <textarea id="contentText" placeholder="დაწერე ტექსტი..." required></textarea>
    <button type="submit" disabled>პოსტის გამოქვეყნება</button>
  </form>
  <div id="loadingSpinner"></div>
  <section id="posts"></section>
</main>

<!-- Inbox modal -->
<div id="inboxModal" role="dialog" aria-modal="true" aria-labelledby="inboxTitle">
  <div id="inboxContent">
    <button id="inboxCloseBtn" aria-label="დახურვა">&times;</button>
    <h2 id="inboxTitle">ინბოქსი</h2>
    <div id="inboxCommentsContainer">დაილოდეთ...</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import {
  getAuth,
  signInAnonymously,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
import {
  getDatabase,
  ref,
  push,
  query,
  orderByChild,
  onValue,
  get
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

// Firebase კონფიგურაცია
const firebaseConfig = {
  apiKey: "AIzaSyBO1nTM6QGumu25F7lnkCHuRjP1o7WF74s",
  authDomain: "tete-bb546.firebaseapp.com",
  databaseURL: "https://tete-bb546-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tete-bb546",
  storageBucket: "tete-bb546.appspot.com",
  messagingSenderId: "985504524225",
  appId: "1:985504524225:web:a0a170ffa30b1e6f66f140"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUid = null;

// ელემენტები
const form = document.getElementById("postForm");
const contentText = document.getElementById("contentText");
const imageInput = document.getElementById("imageInput");
const previewImage = document.getElementById("previewImage");
const imageStatus = document.getElementById("imageStatus");
const errorMessage = document.getElementById("errorMessage");
const postsContainer = document.getElementById("posts");
const loadingSpinner = document.getElementById("loadingSpinner");

const inboxModal = document.getElementById("inboxModal");
const inboxCloseBtn = document.getElementById("inboxCloseBtn");
const inboxCommentsContainer = document.getElementById("inboxCommentsContainer");
const openInboxBtn = document.getElementById("openInboxBtn");

// ფოტოს დამუშავება და ღილაკის კონტროლი
imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = () => {
      previewImage.src = reader.result;
      previewImage.style.display = "block";
      imageStatus.textContent = "✅ ფოტო გამზადებულია პოსტისთვის";
      errorMessage.style.display = "none";
      form.querySelector("button[type=submit]").disabled = !contentText.value.trim();
    };
    reader.readAsDataURL(file);
  } else {
    previewImage.style.display = "none";
    imageStatus.textContent = "";
    form.querySelector("button[type=submit]").disabled = true;
  }
});

// ტექსტის კონტროლი პოსტზე
contentText.addEventListener("input", () => {
  form.querySelector("button[type=submit]").disabled =
    !contentText.value.trim() || !imageInput.files.length;
});

// Base64-ში გადაყვანის ფუნქცია
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    if (!file) return resolve(null);
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error("ფაილის წაკითხვა ვერ მოხერხდა"));
    reader.readAsDataURL(file);
  });
}

// ანონიმური ავტორიზაცია
signInAnonymously(auth).catch((e) => alert("ავტორიზაციის შეცდომა: " + e.message));

// ავტორიზაციის ცვლილების მოსმენა
onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUid = user.uid;
    loadPosts();
    loadInboxComments();
  }
});

// პოსტების ჩატვირთვა ლოდინგით
function loadPosts() {
  loadingSpinner.classList.add("active");
  const postsRef = ref(db, "posts");
  const postsQuery = query(postsRef, orderByChild("timestamp"));
  onValue(
    postsQuery,
    (snapshot) => {
      loadingSpinner.classList.remove("active");
      const posts = [];
      snapshot.forEach((child) => {
        const data = child.val();
        if (data && typeof data.timestamp === "number") {
          posts.push({ id: child.key, ...data });
        }
      });
      posts.sort((a, b) => b.timestamp - a.timestamp);
      renderPosts(posts);
    },
    { onlyOnce: true }
  );
}

// პოსტების ჩვენება
function renderPosts(posts) {
  postsContainer.innerHTML = "";
  if (posts.length === 0) {
    postsContainer.textContent = "პოსტები არ არის.";
    return;
  }

  posts.forEach((post) => {
    const card = document.createElement("article");
    card.className = "post-card";

    // ტექსტი
    const textEl = document.createElement("p");
    textEl.className = "post-text";
    textEl.textContent = post.contentText;
    card.appendChild(textEl);

    // ფოტო
    if (post.imageBase64) {
      const img = document.createElement("img");
      img.className = "post-image";
      img.src = post.imageBase64;
      card.appendChild(img);
    }

    // დრო
    const timeEl = document.createElement("time");
    timeEl.className = "timestamp";
    timeEl.textContent = new Date(post.timestamp).toLocaleString("ka-GE", {
      dateStyle: 'medium',
      timeStyle: 'short'
    });
    card.appendChild(timeEl);

    // კომენტარების ღილაკი
    const commentsToggleBtn = document.createElement("button");
    commentsToggleBtn.className = "comments-toggle";
    commentsToggleBtn.textContent = "კომენტარები";
    card.appendChild(commentsToggleBtn);

    // კომენტარების კონტეინერი
    const commentsContainer = document.createElement("div");
    commentsContainer.className = "comments-container";
    card.appendChild(commentsContainer);

    // კომენტარების ჩვენება/მალვა
    commentsToggleBtn.addEventListener("click", () => {
      if (commentsContainer.style.display === "flex") {
        commentsContainer.style.display = "none";
        commentsToggleBtn.textContent = "კომენტარები";
      } else {
        commentsContainer.style.display = "flex";
        commentsToggleBtn.textContent = "კომენტარები დახურვა";
        loadComments(post.id, commentsContainer);
      }
    });

    postsContainer.appendChild(card);
  });
}

// კომენტარების ჩატვირთვა
function loadComments(postId, container) {
  container.innerHTML = "დაელოდეთ...";

  const commentsRef = ref(db, `comments/${postId}`);
  onValue(
    commentsRef,
    (snapshot) => {
      container.innerHTML = "";
      if (!snapshot.exists()) {
        container.textContent = "კომენტარები არ არის.";
        return;
      }
      snapshot.forEach((child) => {
        const comment = child.val();
        const commentDiv = document.createElement("div");
        commentDiv.className = "comment-text";
        commentDiv.textContent = comment.text;
        container.appendChild(commentDiv);
      });

      // კომენტარის დამატების ფორმა
      const commentForm = document.createElement("form");
      commentForm.className = "comment-form";
      commentForm.innerHTML = `
        <textarea placeholder="დაწერე კომენტარი..." required></textarea>
        <button type="submit">გაგზავნა</button>
      `;
      container.appendChild(commentForm);

      commentForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const textarea = commentForm.querySelector("textarea");
        const text = textarea.value.trim();
        if (!text) return;
        try {
          await push(ref(db, `comments/${postId}`), {
            text,
            timestamp: Date.now(),
            uid: currentUid
          });
          textarea.value = "";
          loadInboxComments(); // ინბოქსისთვის განახლება
          loadComments(postId, container); // რეფრეში კომენტარები
        } catch (error) {
          alert("შეცდომა კომენტარის დამატებისას: " + error.message);
        }
      });
    },
    { onlyOnce: true }
  );
}

// ინბოქსის გახსნა და დახურვა
openInboxBtn.addEventListener("click", () => {
  inboxModal.classList.add("active");
  loadInboxComments();
});
inboxCloseBtn.addEventListener("click", () => {
  inboxModal.classList.remove("active");
});

// ინბოქსში შენს პოსტებზე კომენტარების ჩატვირთვა
function loadInboxComments() {
  if (!currentUid) return;
  inboxCommentsContainer.innerHTML = "დაელოდეთ...";

  const postsRef = ref(db, "posts");
  onValue(
    postsRef,
    (snapshot) => {
      const userPostIds = [];
      snapshot.forEach((child) => {
        const post = child.val();
        if (post && post.uid === currentUid) {
          userPostIds.push(child.key);
        }
      });

      if (userPostIds.length === 0) {
        inboxCommentsContainer.textContent = "ინბოქსი ცარიელია.";
        return;
      }

      let allComments = [];
      let loadedCount = 0;

      userPostIds.forEach((postId) => {
        const commentsRef = ref(db, `comments/${postId}`);
        onValue(
          commentsRef,
          (snap) => {
            loadedCount++;
            if (snap.exists()) {
              snap.forEach((child) => {
                const comment = child.val();
                allComments.push({
                  postId,
                  ...comment,
                });
              });
            }
            if (loadedCount === userPostIds.length) {
              displayInboxComments(allComments);
            }
          },
          { onlyOnce: true }
        );
      });
    },
    { onlyOnce: true }
  );
}

function displayInboxComments(comments) {
  inboxCommentsContainer.innerHTML = "";
  if (comments.length === 0) {
    inboxCommentsContainer.textContent = "ინბოქსი ცარიელია.";
    return;
  }
  // ახალი ვერსია: აჩვენებს კომენტარს + პოსტის ტექსტს (საჭიროა დათვალიერება)
  // ამიტომ ჯერ უნდა წამოვიღოთ პოსტის ტექსტები, რომ გამოაჩინოთ სწორად

  // აქ შეგვიძლია დავაწყვილოთ კომენტარები მათი პოსტის ტექსტთან
  const postsRef = ref(db, "posts");
  get(postsRef).then((postsSnap) => {
    const postsMap = {};
    postsSnap.forEach((postSnap) => {
      postsMap[postSnap.key] = postSnap.val();
    });

    // დავალაგოთ და გავაჩინოთ კომენტარები
    comments.sort((a, b) => b.timestamp - a.timestamp);
    comments.forEach((comment) => {
      const postText = postsMap[comment.postId]?.contentText || "[პოსტი წაშლილია]";
      const div = document.createElement("div");
      div.className = "inbox-comment";
      div.innerHTML = `<strong>პოსტის ტექსტი:</strong> <em>${escapeHtml(postText)}</em><br><strong>კომენტარი:</strong> ${escapeHtml(comment.text)}`;
      inboxCommentsContainer.appendChild(div);
    });
  });
}

// უსაფრთხო HTML-ით გამოტანა XSS-ისგან დასაცავად
function escapeHtml(text) {
  if (!text) return "";
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// პოსტის გამოქვეყნება
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const text = contentText.value.trim();
  const file = imageInput.files[0];

  if (!file) {
    errorMessage.style.display = "block";
    return;
  }
  errorMessage.style.display = "none";

  if (!text) return;

  let imageBase64;
  try {
    imageBase64 = await fileToBase64(file);
  } catch {
    alert("სურათის წაკითხვა ვერ მოხერხდა.");
    return;
  }

  const newPost = {
    uid: currentUid,
    contentText: text,
    imageBase64,
    timestamp: Date.now(),
  };

  try {
    await push(ref(db, "posts"), newPost);
    form.reset();
    previewImage.style.display = "none";
    imageStatus.textContent = "";
    form.querySelector("button[type=submit]").disabled = true;
    loadPosts(); // ახალი პოსტის დამატების შემდეგ ჩატვირთე პოსტები
  } catch (err) {
    alert("შეცდომა პოსტის დამატებისას: " + err.message);
  }
});
      
</script>
</body>

</html>
