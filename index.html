<!DOCTYPE html>
<html lang="ka">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>საჯარო პოსტები</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root {
      --color-primary: #2563eb;
      --color-primary-dark: #1e40af;
      --color-background: #f5f7fa;
      --color-card-bg: #ffffff;
      --color-text-primary: #111827;
      --color-text-secondary: #6b7280;
      --color-border: #e5e7eb;
      --color-shadow-light: rgba(0, 0, 0, 0.05);
      --color-shadow-dark: rgba(0, 0, 0, 0.1);
      --radius-base: 18px;
      --spacing-base: 16px;
      --font-family: 'Inter', sans-serif;
    }
    @font-face {
  font-family: 'myffont';
  src: url('alk-sanet.ttf');
}
    * {
      box-sizing: border-box;
      padding: 0;
      margin: 0;
      font-family: 'myffont';
    }

    body {
      font-family: var(--font-family);
      background-color: var(--color-background);
      color: var(--color-text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background-color: var(--color-primary);
      color: white;
      font-weight: 700;
      font-size: 1.5rem;
      padding: var(--spacing-base);
      text-align: center;
      box-shadow: 0 4px 12px var(--color-shadow-dark);
    }

    main {
      flex: 1;
      max-width: 480px;
      margin: var(--spacing-base) auto 2rem;
      width: 95%;
      display: flex;
      flex-direction: column;
      gap: 1.75rem;
      padding: 0 var(--spacing-base);
    }

    form {
      background: var(--color-card-bg);
      border-radius: var(--radius-base);
      padding: 1.75rem 1.5rem;
      box-shadow: 0 8px 16px var(--color-shadow-light), inset 0 0 0 1px var(--color-border);
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    textarea {
      resize: vertical;
      min-height: 110px;
      border: 1.5px solid var(--color-border);
      border-radius: 14px;
      padding: 1rem 1.25rem;
      font-size: 1.125rem;
      background: var(--color-background);
    }

    textarea::placeholder {
      color: var(--color-text-secondary);
      font-weight: 500;
    }

    textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
    }

    .camera-button {
      display: inline-block;
      text-align: center;
      background-color: var(--color-primary);
      color: white;
      padding: 0.9rem 1rem;
      font-weight: 700;
      font-size: 1.1rem;
      border-radius: 14px;
      cursor: pointer;
      transition: 0.3s ease;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.5);
      user-select: none;
    }

    .camera-button:hover {
      background-color: var(--color-primary-dark);
      transform: translateY(-2px);
    }

    #imageInput {
      display: none;
    }

    button {
      background-color: var(--color-primary);
      border: none;
      border-radius: 14px;
      padding: 1rem 0;
      font-weight: 700;
      font-size: 1.2rem;
      color: white;
      cursor: pointer;
      
      transition: background-color 0.3s ease;
    }

    button:disabled {
      background-color: #93c5fd;
      box-shadow: none;
      cursor: not-allowed;
    }

    #posts {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .post-card {
      background: var(--color-card-bg);
      border-radius: var(--radius-base);
      padding: 1.5rem 1.75rem;
      box-shadow: 0 12px 24px var(--color-shadow-light);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      cursor: pointer;
      transition: box-shadow 0.3s ease;
    }

    .post-card:hover {
      box-shadow: 0 18px 36px rgba(0,0,0,0.12);
    }

    .post-text {
      font-size: 1.125rem;
      line-height: 1.6;
      white-space: pre-wrap;
      font-weight: 500;
      user-select: text;
    }

    .post-image {
      width: 100%;
      height: auto;
      border-radius: 14px;
      border:2px solid dimgray;
      object-fit: contain;
      user-select: none;
      pointer-events: none; /* მოდალის გახსნისთვის მხოლოდ პოსტზე კლიკი და არა ფოტოზე */
    }

    .timestamp {
      font-size: 0.8rem;
      color: var(--color-text-secondary);
      align-self: flex-end;
      font-weight: 600;
      user-select: none;
    }

    /* Preview image and status */
    #previewImage {
      max-width: 100%;
      border-radius: 14px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
      object-fit: cover;
      max-height: 280px;
      aspect-ratio: 16 / 9;
      display: none;
      margin-top: -0.5rem;
    }

    #imageStatus {
      font-size: 0.9rem;
      color: var(--color-text-secondary);
      font-weight: 600;
      margin-top: -0.5rem;
      margin-bottom: 0.5rem;
      min-height: 1.2rem;
      user-select: none;
    }

    /* Modal styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 1rem;
    }

    .modal[aria-hidden="false"] {
      display: flex;
    }

    .modal-content {
      position: relative;
      background: white;
      border-radius: 20px;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1rem 1.5rem 2rem 1.5rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .modal img {
      max-width: 100%;
      height: auto;
      border-radius: 14px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      user-select: none;
    }

    .modal p {
      font-size: 1.2rem;
      color: #111827;
      font-weight: 600;
      white-space: pre-wrap;
      text-align: center;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      font-size: 2.5rem;
      background: none;
      border: none;
      cursor: pointer;
      color: #FF0000;
      font-weight: 700;
      user-select: none;
      line-height: 1;
    }
  </style>
</head>
<body>

<header>
  ჩასელფე
  <div id="activeUsers" style="font-size: 0.9rem; margin-top: 10px;">0</div>
</header>

<main>
  <form id="postForm" autocomplete="off" novalidate>
    <label for="imageInput" class="camera-button">ფოტოს გადაღება</label>
    <textarea id="contentText" placeholder="დაწერე ტექსტი..." required></textarea>
    <input type="file" id="imageInput" accept="image/*" capture="environment" />

    <img id="previewImage" alt="ფოტოს პრევიუ" />
    <p id="imageStatus"></p>

    <button type="submit" disabled>პოსტის გამოქვეყნება</button>
  </form>

  <section id="posts"></section>
</main>

<!-- მოდალური ფანჯარა -->
<div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalText">
  <div class="modal-content">
    <button id="modalClose" class="modal-close" aria-label="დახურვა">&times;</button>
    <img id="modalImage" alt="პოსტის ფოტო" />
    <p id="modalText"></p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    query,
    orderByChild,
    onValue,
    set,
    onDisconnect,
    remove
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBO1nTM6QGumu25F7lnkCHuRjP1o7WF74s",
    authDomain: "tete-bb546.firebaseapp.com",
    databaseURL: "https://tete-bb546-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "tete-bb546",
    storageBucket: "tete-bb546.appspot.com",
    messagingSenderId: "985504524225",
    appId: "1:985504524225:web:a0a170ffa30b1e6f66f140"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const postsRef = ref(db, 'posts');

  const form = document.getElementById('postForm');
  const contentText = document.getElementById('contentText');
  const imageInput = document.getElementById('imageInput');
  const submitBtn = form.querySelector('button');
  const postsContainer = document.getElementById('posts');
  const previewImage = document.getElementById('previewImage');
  const imageStatus = document.getElementById('imageStatus');
  const modal = document.getElementById('modal');
  const modalImage = document.getElementById('modalImage');
  const modalText = document.getElementById('modalText');
  const modalClose = document.getElementById('modalClose');
  const activeUsersEl = document.getElementById('activeUsers');

  // ✅ ონლაინ მომხმარებლების აღრიცხვა
  const uid = 'user_' + Math.random().toString(36).slice(2);
  const userRef = ref(db, `presence/${uid}`);
  set(userRef, { online: true }).then(() => {
    onDisconnect(userRef).remove();
  });

  const presenceRef = ref(db, 'presence');
  onValue(presenceRef, snapshot => {
    const activeCount = snapshot.exists() ? snapshot.size : 0;
    activeUsersEl.textContent = `⬤ ონლაინ: ${activeCount}`;
  });

  // ღილაკის აქტიურობა ტექსტზე
  contentText.addEventListener('input', () => {
    submitBtn.disabled = !contentText.value.trim();
  });

  imageInput.addEventListener('change', () => {
    const file = imageInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        previewImage.src = reader.result;
        previewImage.style.display = 'block';
        imageStatus.textContent = '✅ ფოტო გამზადებულია პოსტისთვის';
      };
      reader.readAsDataURL(file);
    } else {
      previewImage.src = '';
      previewImage.style.display = 'none';
      imageStatus.textContent = '';
    }
  });

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      if (!file) return resolve(null);
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject(new Error('ფაილის წაკითხვა ვერ მოხერხდა'));
      reader.readAsDataURL(file);
    });
  }

  function formatTimestamp(ts) {
    const d = new Date(ts);
    return d.toLocaleString('ka-GE', { dateStyle: 'medium', timeStyle: 'short' });
  }

  function renderPost(post) {
    const card = document.createElement('article');
    card.className = 'post-card';

    const textEl = document.createElement('p');
    textEl.className = 'post-text';
    textEl.textContent = post.contentText;
    card.appendChild(textEl);

    if (post.imageBase64) {
      const img = document.createElement('img');
      img.className = 'post-image';
      img.src = post.imageBase64;
      img.alt = 'დაპოსტილი სურათი';
      card.appendChild(img);
    }

    const timeEl = document.createElement('time');
    timeEl.className = 'timestamp';
    timeEl.dateTime = new Date(post.timestamp).toISOString();
    timeEl.textContent = formatTimestamp(post.timestamp);
    card.appendChild(timeEl);

    card.addEventListener('click', () => {
      openModal(post);
    });

    return card;
  }

  const postsQuery = query(postsRef, orderByChild('timestamp'));
  onValue(postsQuery, (snapshot) => {
    const posts = [];
    snapshot.forEach(child => {
      const data = child.val();
      if (data && typeof data.timestamp === "number") {
        posts.push(data);
      }
    });

    posts.sort((a, b) => b.timestamp - a.timestamp);
    postsContainer.innerHTML = '';
    posts.forEach(post => {
      postsContainer.appendChild(renderPost(post));
    });
  });

  form.addEventListener('submit', async e => {
    e.preventDefault();
    submitBtn.disabled = true;

    const text = contentText.value.trim();
    if (!text) {
      submitBtn.disabled = false;
      return;
    }

    let imageBase64 = null;
    if (imageInput.files.length > 0) {
      try {
        imageBase64 = await fileToBase64(imageInput.files[0]);
      } catch {
        alert('სურათის წაკითხვა ვერ მოხერხდა.');
        submitBtn.disabled = false;
        return;
      }
    }

    const newPost = {
      contentText: text,
      imageBase64,
      timestamp: Date.now()
    };

    try {
      await push(postsRef, newPost);
      form.reset();
      contentText.dispatchEvent(new Event('input'));
      previewImage.src = '';
      previewImage.style.display = 'none';
      imageStatus.textContent = '';
    } catch (err) {
      alert('შეცდომა: ' + err.message);
      submitBtn.disabled = false;
    }
  });

  function openModal(post) {
    modalImage.src = post.imageBase64 || '';
    modalText.textContent = post.contentText;
    modal.setAttribute('aria-hidden', 'false');
    modal.scrollTop = 0;
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modal.setAttribute('aria-hidden', 'true');
    modalImage.src = '';
    modalText.textContent = '';
    document.body.style.overflow = '';
  }

  modalClose.addEventListener('click', closeModal);
  modal.addEventListener('click', e => {
    if (e.target === modal) closeModal();
  });
  document.addEventListener('keydown', e => {
    if (e.key === "Escape" && modal.getAttribute('aria-hidden') === 'false') {
      closeModal();
    }
  });
</script>
</body>
</html>
